<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
  th:replace="layout/base :: page('Products', ~{::section})"
>
  <section class="hx-section">
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
      <div>
        <h1 class="h4 mb-1">Store</h1>
        <p class="text-muted mb-0">Field guides, maps, and study packs.</p>
      </div>
      <a class="btn btn-outline-secondary btn-sm" th:href="@{/orders}" sec:authorize="isAuthenticated()">My orders</a>
    </div>

    <div class="row g-3">
      <div class="col-md-4" th:each="p : ${items}">
        <div class="hx-card h-100">
          <img
            th:src="${p.imageUrl} ?: 'https://images.unsplash.com/photo-1489515217757-5fd1be406fef?auto=format&fit=crop&w=900&q=80'"
            alt="Product"
          />
          <div class="mt-3">
            <h2 class="h5 text-white mb-1" th:text="${p.name}">Product</h2>
            <p class="text-muted" th:text="${p.description} ?: 'No description yet.'">Description</p>
            <div class="d-flex align-items-center justify-content-between">
              <span class="small text-muted" th:text="'Stock: ' + ${p.stock}">Stock</span>
              <span class="h6 mb-0 text-white" th:text="'$' + ${#numbers.formatDecimal(p.price, 1, 2)}">$0.00</span>
            </div>
          </div>

          <div class="mt-3 d-flex align-items-center gap-2">
            <form
              sec:authorize="isAuthenticated()"
              th:action="@{/products/{id}/buy(id=${p.id})}"
              method="post"
            >
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <button class="btn btn-dark btn-sm" th:disabled="${p.stock == 0}">Buy</button>
            </form>
            <span class="small text-muted" sec:authorize="!isAuthenticated()">Login to purchase</span>
          </div>
        </div>
      </div>
    </div>

    <div
      class="d-flex justify-content-between align-items-center mt-3"
      th:if="${page != null and page.totalPages > 1}"
    >
      <a
        class="btn btn-outline-secondary btn-sm"
        th:classappend="${page.first} ? 'disabled'"
        th:href="@{/products(page=${page.number-1}, size=${page.size})}"
      >
        Prev
      </a>

      <div class="small text-muted">
        Page <span th:text="${page.number + 1}">1</span> /
        <span th:text="${page.totalPages}">1</span>
      </div>

      <a
        class="btn btn-outline-secondary btn-sm"
        th:classappend="${page.last} ? 'disabled'"
        th:href="@{/products(page=${page.number+1}, size=${page.size})}"
      >
        Next
      </a>
    </div>
  </section>
</html>
