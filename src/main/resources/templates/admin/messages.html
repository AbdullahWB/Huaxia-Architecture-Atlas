<!DOCTYPE html>
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
  th:replace="layout/base :: page('Messages', ~{::section})"
>
  <section>
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <h1 class="h4 mb-0">Messages</h1>
    </div>

    <div class="btn-group mt-3" role="group" aria-label="filter tabs">
      <a
        class="btn btn-outline-dark"
        th:classappend="${isRead == null} ? 'active'"
        th:href="@{/admin/messages}"
        >All</a
      >
      <a
        class="btn btn-outline-dark"
        th:classappend="${isRead != null and isRead == false} ? 'active'"
        th:href="@{/admin/messages(isRead=false)}"
        >Unread</a
      >
      <a
        class="btn btn-outline-dark"
        th:classappend="${isRead != null and isRead == true} ? 'active'"
        th:href="@{/admin/messages(isRead=true)}"
        >Read</a
      >
    </div>

    <div class="vstack gap-3 mt-3">
      <div class="hx-card" th:each="m : ${items}">
        <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
          <div>
            <div class="d-flex align-items-center gap-2">
              <span
                class="badge text-bg-light border"
                th:text="${m.read} ? 'READ' : 'UNREAD'"
                >UNREAD</span
              >
              <span
                class="small text-muted"
                th:if="${m.createdAt != null}"
                th:text="${#temporals.format(m.createdAt, 'yyyy-MM-dd HH:mm')}"
                >Date</span
              >
            </div>
            <div class="h6 mt-2 mb-1" th:text="${m.subject} ?: '(No subject)'">
              (No subject)
            </div>
            <div class="small text-muted">
              <span th:text="${m.name}">Name</span>
              <span class="px-1">?</span>
              <span th:text="${m.email}">Email</span>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <form
              class="d-inline"
              th:if="${!m.read}"
              th:action="@{/admin/messages/{id}/read(id=${m.id})}"
              method="post"
            >
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button class="btn btn-sm btn-outline-success">Mark read</button>
            </form>

            <form
              class="d-inline"
              th:if="${m.read}"
              th:action="@{/admin/messages/{id}/unread(id=${m.id})}"
              method="post"
            >
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button class="btn btn-sm btn-outline-secondary">Mark unread</button>
            </form>
          </div>
        </div>

        <div class="mt-3">
          <div class="small text-muted">Message</div>
          <div class="white-space-prewrap" th:text="${m.message}">Message</div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-lg-6">
            <div class="small text-muted mb-2">Manual reply</div>
            <form th:action="@{/admin/messages/{id}/reply(id=${m.id})}" method="post">
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <textarea
                class="form-control"
                rows="5"
                name="adminReply"
                th:text="${m.adminReply}"
              ></textarea>
              <button class="btn btn-outline-secondary btn-sm mt-2">
                Save reply
              </button>
            </form>
            <div class="small text-muted mt-2" th:if="${m.adminReply}">
              Saved reply on file.
            </div>
          </div>

          <div class="col-lg-6">
            <div class="small text-muted mb-2">AI reply draft</div>
            <div class="hx-ai-reply white-space-prewrap" th:text="${m.aiReply} ?: 'No AI draft yet.'">
              No AI draft yet.
            </div>
            <form
              class="mt-2"
              th:action="@{/admin/messages/{id}/reply/ai(id=${m.id})}"
              method="post"
            >
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button class="btn btn-dark btn-sm">Generate AI reply</button>
            </form>
          </div>
        </div>
      </div>

      <div class="text-muted" th:if="${items == null || #lists.isEmpty(items)}">
        No messages found.
      </div>
    </div>
  </section>
</html>
