# Azure Deployment Plan for Huaxia-Architecture-Atlas Project
## **Goal**
Provide a plan to deploy the Huaxia-Architecture-Atlas project to Azure using AZD. 

## **Project Information**
**Huaxia-Architecture-Atlas**
- **Stack**: Spring Boot (Java 17), FastAPI (Python)
- **Type**: Web app for exploring ancient Chinese architecture, with AI chat, community posts, products, and an optional ML service
- **Containerization**: Dockerfiles need to be generated
- **Dependencies**: MySQL database, ML service
- **Hosting**: Azure Container Apps

## **Azure Resources Architecture**
```mermaid
graph TD
%% Services
svcazurecontainerapps_huaxiaarchitectureatlas["`Name: Huaxia-Architecture-Atlas
Path: .
Language: java`"]
svcazurecontainerapps_mlservice["`Name: ml-service
Path: ml-service
Language: python`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_huaxiaarchitectureatlas("`Huaxia-Architecture-Atlas (Azure Container App)`")
azurecontainerapps_mlservice("`ml-service (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Dependency Resources"
%% Dependency Resources
azuredatabaseformysql_mysql["`mysql (Azure Database for MySQL)`"]
end
%% Relationships
svcazurecontainerapps_huaxiaarchitectureatlas --> |"hosted on"| azurecontainerapps_huaxiaarchitectureatlas
azurecontainerapps_huaxiaarchitectureatlas -.-> |"secret"| azuredatabaseformysql_mysql
azurecontainerapps_huaxiaarchitectureatlas -.-> |"http"| azurecontainerapps_mlservice
svcazurecontainerapps_mlservice --> |"hosted on"| azurecontainerapps_mlservice
```
- The main app (Huaxia-Architecture-Atlas) connects to the MySQL database via secret connection string.
- The main app communicates with the ML service via HTTP.
- Both services are hosted on Azure Container Apps.

## **Recommended Azure Resources**
Application Huaxia-Architecture-Atlas:
- Hosting Service Type: Azure Container Apps
- SKU: Standard (supports up to 10 vCPU and 16 GB RAM, suitable for web apps)
- Configuration:
    - language: java
    - Environment Variables: [MYSQL_DATABASE, MYSQL_ROOT_PASSWORD, MYSQL_PORT, SPRING_DATASOURCE_URL, SPRING_DATASOURCE_USERNAME, SPRING_DATASOURCE_PASSWORD, DEEPSEEK_API_KEY, DEEPSEEK_MODEL, DEEPSEEK_BASE_URL]
    - dockerFilePath: ./Dockerfile
    - dockerContext: .
- Dependencies Resource:
    - Dependency Name: mysql
    - SKU: General Purpose (2 vCPU, 8 GB RAM, 100 GB storage)
    - Service Type: Azure Database for MySQL
    - Connection Type: secret
    - Environment Variables: [MYSQL_DATABASE, MYSQL_ROOT_PASSWORD, MYSQL_PORT, SPRING_DATASOURCE_URL, SPRING_DATASOURCE_USERNAME, SPRING_DATASOURCE_PASSWORD]

Application ml-service:
- Hosting Service Type: Azure Container Apps
- SKU: Standard (supports up to 10 vCPU and 16 GB RAM)
- Configuration:
    - language: python
    - Environment Variables: []
    - dockerFilePath: ./ml-service/Dockerfile
    - dockerContext: ./ml-service
- Dependencies Resource: None

## **Recommended Supporting Services**:
- Application Insights
- User-Assigned Managed Identity
- Log Analytics Workspace: set all app service to connect to this
- Key Vault: Create to store MySQL connection string
- Container Registry

## **Recommended Security Configurations**:
- User-Assigned Managed Identity must have permissions into the Key Vault.
- User-Assigned Managed Identity must be assigned to all supported resources
- AcrPull role assignment: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry.

## **Execution Step**
Execution Steps:
1. Containerization:
    - If Dockerfiles exist, list their paths.
    - If missing: Ensure the repo is analyzed using appmod-analyze-repository.
    - Based on that response, use appmod-plan-generate-dockerfile to generate the required Dockerfiles. Agent must create Dockerfile first before deployment!
    - Output: Docker artifacts
2. Create Azure Infrastructure Files for AZD:
    1. Provisioning tool: AZD. Expected files: infra/main.bicep, infra/main.parameters.json
    2. Grab current subscriptionID, call tool `appmod-get-available-region-sku` to get available region and SKUs for all needed Azure resource types. 
    3. If expected files exist, please follow the below steps:
        - Existing file paths: <check if exist>
        - Check if the Azure resources in the existing files match what we required in the plan. If not, add steps to update the existing files with missing Azure resource.
        - Generating Files: No
    4. If expected files do not exist, please follow the below steps:
        - Generate the missing expected files, call tool `appmod-get-iac-rules` to get the rules for file generation.
        - Call `get_errors` on the generated files and iterate on any errors.
        - Generating Files: Yes
    5. Fix the  files and retry if there's any error in the provisioning files. Use `get_errors` tool if available to help look for errors.
3. Env setup for azd:
    1. Install AZ CLI and AZD if not installed.
    2. Run 'azd env new <envName> --no-prompt' to create a new environment, generating a name for the user. If there's existing environment, check if the environment matches the requirements.
    3. Review infra/main.tf, infra/variables.tf, infra/terraform.tfvars.json for environment variables. Set these for the user using azd env set <key> <value>. Use default values (from AZ CLI) if not provided by the user. Subscription ID is always required.
    4. Set the subscription: Use default subscription
    5. Set AZURE_RESOURCE_GROUP environment variable. The region of the resource group does not have to match its inner resources.
4. Deployment:
    1. Run `azd provision --preview --no-prompt` to dry run your infrastructure and confirm everything is well-formed.
    2. Azd App Deployment:
        1. Run `azd up --no-prompt`. Iterate on any errors, and retry.
    3. Deployment Validation:
        1. Check the application log with tool `appmod-get-azd-app-logs` to ensure the services are running.
5. Summarize Deployment Result:
    1. Use `appmod-summarize-result` tool to summarize the deployment result.
    2. Generating files: .azure/summary.copilotmd

## **Progress Tracking**
- Copilot must create and update `.azure/progress.copilotmd` after each step.  
- Progress should include:  
  - ‚úÖ Completed tasks  
  - üî≤ Pending tasks  
  - ‚ùå Failed tasks with error notes
If a script fails, log the error, regenerate/fix the script, and retry until the step completes.  

## **Tools Checklist**
- [x] appmod-analyze-repository
- [] appmod-plan-generate-dockerfile
- [] appmod-get-available-region-sku
- [] appmod-get-iac-rules
- [] appmod-summarize-result